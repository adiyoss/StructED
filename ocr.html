<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="StructED, structured prediction learning package">
    <meta name="author" content="adiyoss yossi adi joseph keshet">
    <link rel="icon" href="../../favicon.ico">

    <title>StructED</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.css" rel="stylesheet">

   <!-- Custom styles for this template -->
    <link href="css/navbar-fixed-top.css" rel="stylesheet">
    <link href="css/sticky-footer-navbar.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/jumbotron.css" rel="stylesheet">

    <link href="css/style.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="assets/ie-emulation-modes-warning.js"></script>

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- USED FOR LATEX CODE INSIDE THE HTML -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]}
      });
    </script>
    <script type="text/javascript" src="js/MathJax.js"></script> 
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="index.html">StrcutED</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">            
            <li><a href="introduction.html">Introduction</a></li>
            <li><a href="algorithms.html">Algorithms</a></li>
            <li><a href="api/index.html" target="blank">API</a></li>
            <li><a href="examples.html">Examples</a></li>
            <li><a href="contact.html">Contact</a></li>            
            <li><a href="https://github.com/adiyoss/StructED" target="blank"><i class="fa fa-github fa-fw fa-lg"></i></a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="container">
      <div>      
        <h2 class="text-center">OCR</h2>
        <hr>
        <div>
          <div>
            In this tutorial we will demonstrate how to use StructED for a classical structured prediction task - Letter sequence recognition. For this tutorial we will use the standard benchmark OCR dataset of Rob Kassel, you can download the full data set from <a href="http://ai.stanford.edu/~btaskar/ocr/">OCR</a>. <br>
          </div>

          <h3>A Little Bit About The Task</h3>    
          <hr>
          <div>
            This dataset contains handwritten words collected by Rob Kassel at MIT Spoken Language Systems Group. Each word were pre-segmented into charterers. Each character is represented as a 16x8 binary image. The task is to classify the image into one of the 26 characters a-z. The first letter of every word was omitted as it was capitalized and the task does only consider small caps letters. Our goal is to exploit the correlations between neighboring letters in order to create more accurate predictions of words.
            <br><br>   
            Clearly there are more interesting ways to solve this problem, but we want to demonstrate how to use StructED with more complex inference.
          </div>

          <h3>The Code</h3>
          <hr>
          <div>
              Here, we present what classes do we need to add and what interfaces do we need to implement. We provide the source code for all of the classes and interfaces. <br><br>

              First, we should setup our development environment. Open a Java project and add the StructED jar file to your build path (it can be found under the bin directory at StructED repository). You can download all StructED source codes and jar files from <a href="https://github.com/adiyoss/StructED" target="blank">GitHub.</a>
              <br><br>
              
              Note, if you would like to use one of our datasets for any of the tutorials or unit tests, you should copy the data folder to the project directory or change the path in the marked places in the code to the where you store the data.
              <br><br>
              
              Now let's begin!
              <br><br>
          </div>
        
          </div>
          <h4>Task Loss</h4>
          <div>
              In order to add new loss/cost function one needs to implement the ITaskLoss interface. For this tutorial we implemented a 0/1 loss for every letter in a given word sequences: <br>
              <p class="text-center">              
                \begin{equation}
                \label{eq:loss}
                  \ell (y,\hat{y}) = \frac{\sum_{i=1}^m{\mathcal{1}\!\left[y_i \ne \hat{y_i}\right]}}{m}
                \end{equation}   
              </p><br>
              In other words, the loss is the average character error for the whole word. The loss will be one if y is not equal to $\hat{y}$ in every letter in the word, and zero when they are the same. <br>
            The code for the loss function can be found at src.com.structed.models.loss.TaskLossOCR.java on StructED GitHub repository.
              <br><br>                          
          </div>
          <h4>Inference</h4>
          <div>
            The inference for this task involves some dynamic programing in order to get the best sequence of words. The inference procedure we implemented is the same as in: <a href="http://papers.nips.cc/paper/2397-max-margin-markov-networks.pdf">Max-Margin Markov Networks by Ben Tasker et al.</a> <br>
            The code for the inference procedure can be found at src.com.structed.models.inference.InferenceOCR.java on StructED GitHub repository.
          </div>
          <h4>Feature Functions</h4>
          <div>
            The feature functions we use are the same as in <a href="http://papers.nips.cc/paper/2397-max-margin-markov-networks.pdf">Max-Margin Markov Networks by Ben Tasker et al.</a> <br>
            We use the image values with additional indicator feature for the previous letter. <br>
            The code for the feature functions can be found at src.com.structed.data.featurefunctions.FeatureFunctionsOCR.java on StructED GitHub repository.
          </div>
          
          <h3>Running The Code</h3>    
          <hr>
          <div>
                Now we can create a StructEDModel object with the interfaces we have just implemented, all we have left to do is to choose the model. In this example code we were inspired by PyStruct package, and compared between the multi-class approach (classify for each letter without paying attention to the previous one) and the structured approach (with a special feature for the previous letter). 
                  <br><br>
                  Here is a snippet of such code (the complete code can be found at the package repository under tutorials-code folder):
                  <br><br>
            <div>
              <pre class="prettyprint">                     
        // ===================== MULTI CLASS ===================== //
       Logger.info("================= Multi-class version =================");
       Logger.info("Loading data...");
       // === LOADING DATA === //
       InstancesContainer ocrAllInstancesMulti = reader.readDataMultiClass(dataPath, Consts.TAB, 
                Consts.COLON_SPLITTER);
       InstancesContainer ocrTrainInstancesMulti = getFold(ocrAllInstancesMulti, 1, true);
       InstancesContainer ocrTestInstancesMulti = getFold(ocrAllInstancesMulti, 1, false);
       if (ocrTrainInstancesMulti.getSize() == 0) return;
       // ==================== //

       W = new Vector() {{put(0, 0.0);}}; // init the first weight vector
       arguments = new ArrayList<Double>() {{add(500.0);}}; // model parameters

       // ======= PA MULTI-CLASS MODEL ====== //
       // create the model
       StructEDModel ocr_model_multi_class = new StructEDModel(W, new PassiveAggressive(), 
                new TaskLossMultiClass(), new InferenceMultiClass(Char2Idx.char2id.size()-1), null, 
                new FeatureFunctionsSparse(Char2Idx.char2id.size()-1, maxFeatures), arguments); 
       ocr_model_multi_class.train(ocrTrainInstancesMulti, null, null, epochNum, isAvg, true); // train
       ocr_model_multi_class.predict(ocrTestInstancesMulti, null, 1, false); // predict
       // ======================================================= //

        // ====================== STRUCTURED ===================== //
        Logger.info("================= Structured version =================");
        // === LOADING DATA === //
        InstancesContainer ocrAllInstances = reader.readData(dataPath, Consts.TAB, 
                Consts.COLON_SPLITTER);
        InstancesContainer ocrTrainInstancesStruct = getFold(ocrAllInstances, 1, true);
        InstancesContainer ocrTestInstancesStruct = getFold(ocrAllInstances, 1, false);
        if (ocrTrainInstancesStruct.getSize() == 0) return;
        // ==================== //

        // ======= PA STRUCTURED MODEL ====== //
        W = new Vector() {{put(0, 0.0);}}; // init the first weight vector
        arguments = new ArrayList<Double>() {{add(15.0);}}; // model parameters

        StructEDModel ocr_model = new StructEDModel(W, new PassiveAggressive(), 
                new TaskLossOCR(), new InferenceOCR(), null, 
                new FeatureFunctionsOCR(maxFeatures), arguments); // create the model
        ocr_model.train(ocrTrainInstancesStruct, null, null, epochNum, isAvg, true); // train
        ocr_model.predict(ocrTestInstancesStruct, null, 1, false); // predict        
        Graph g = new Graph();
        g.drawHeatMap(ocr_model, start_transition_characters, nam_of_characters);
        // ======================================================= //
              </pre>
            </div>  
            <br><br>                      
            <div>
              <div class="row-fluid">
                <hr>
                After running the code the results suppose to be around: <br>
                Multi-class: 0.29% error rate<br>
                Structured: 0.22% error rate<br>
                <hr>
              </div>
              <div class="row">
                <div class="col-md-7">
                In addition we generated a plot of the previous letter feature. We can consider this feature as a character transition matrix, the probability for two letter to appear one after the other.
                </div>
                <div class="col-md-5">
                  <img src="img/heat_map.png" class="img-responsive pull-right" alt="Characters Transition Matrix">
                </div>
              </div>  
            </div>                    
            <div>            
            </div>
          </div>
        </div>        
      </div>
    </div> <!-- /container -->    
    
    <footer class="footer">
      <div class="container">        
      </div>
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="assets/ie10-viewport-bug-workaround.js"></script>
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
  </body>
</html>
